@layer components {

  .vt-page {
    view-transition-name: page;
  }
  .upper-deck-card {
    view-transition-name: deck;
  }

  ::view-transition-group(deck) { z-index: 2; }
  ::view-transition-group(page) { z-index: 1; }

  /* Keep the deck frozen (no crossfade/move) */
  ::view-transition-old(deck) {animation: none; }
  ::view-transition-new(deck) { animation: none; }

  /* old page: slide down immediately */
  ::view-transition-old(page) {
    animation: vt-slide-out 0.3s ease-out both;
  }

  /* new page: wait a beat, then slide up */
  ::view-transition-new(page) {
    animation: vt-slide-in 0.3s ease-in both;
    animation-delay: .3s;
  }

  .load-anim-in { animation: vt-slide-in .3s ease-in both; }
  .load-anim-out { animation: vt-slide-out .3s ease-out both; }

  /* keyframes */
  @keyframes vt-slide-out {
  from {
    transform: none; 
  }
  to   {
    transform: translateY(80dvh);
  }
  }
  @keyframes vt-slide-in {
  from {
    transform: translateY(80dvh);
  }
  to   {
    transform: none;
  }
  }

  /* accessibility */
  @media (prefers-reduced-motion: reduce) {
    ::view-transition-old(page), ::view-transition-new(page) { animation: none; }
  }

  .site-header {
    position: sticky;
    inset-block-start: 0;
    padding: var(--s-4);
    z-index: 10;
    background: color-mix(in oklch, var(--surface), black 5%);
    box-shadow: 0 var(--s-2) var(--s-1) oklch(0% 0 0 / 25%);
  }

  /* Footer just sits at the bottom row */
  .site-footer {
    padding: 0 var(--s-2);
    & > nav > a {
      color: var(--muted);
      &:hover {
        color: var(--brand);
      }
    }
  }

  .deck {
    --surface: var(--surface-deep);
    position: absolute;
    min-inline-size: min(80dvw, 35ch);
    min-height: calc(30px + 2.5rem);
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    overflow: hidden;
  }

  .deck-card {
    position: absolute;
    min-height: 30ch;
  }

  .card, [popover] {
    color: var(--ink);
    background: var(--surface);
    border: var(--border);
    border-radius: var(--radius);
    padding: var(--padding);

    inline-size: fit-content;
    max-inline-size: min(60ch, calc(100dvi - 2rem));
    overflow-wrap: anywhere;

    box-shadow: var(--shadow);

    &.deck-card {
      box-shadow: none;
      background: var(--surface-deep);
      border: 2px solid oklch(from var(--surface-deep) calc(l + 0.03) c h / .6);
    }
  }

  [popover] {
    opacity: 0;
    transform: scale(0);

    transition:
      display .3s allow-discrete,
      overlay .3s allow-discrete,
      opacity 0.3s,
      transform 0.3s;
  }
  [popover]:popover-open {
    box-shadow: 0 0 var(--s1) var(--focus);

    opacity: 1;
    transform: scale(1);

    @starting-style {
      opacity: 0;
      transform: scale(0);
    }
  }
  [popover]::backdrop{
    background-color: transparent;
    backdrop-filter: blur(0);

    transition:
      display .3s allow-discrete,
      overlay .3s allow-discrete,
      backdrop-filter .3s,
      background-color .3s;
  }

  [popover]:popover-open::backdrop {
    backdrop-filter: blur(var(--s-2));
    background-color: oklch(0 0 0 / 50%);

    @starting-style {
      backdrop-filter: blur(0);
      background-color: transparent;
    }
  }

  .icon {
    inline-size: 2.5cap;
    block-size: 2.5cap;
    aspect-ratio: 1;
    display: inline-block;
    margin: 0 var(--s-2);
    vertical-align: middle;
    fill: currentColor;
    stroke: currentColor;
  }

  /* Safe, minimal button reset */
  button.icon-btn {
    overflow: visible;
    appearance: none;
    border: 0;
    background: none;
    color: inherit;
    font: inherit;
    line-height: inherit;
    padding: var(--s-3);
    margin: 0;

    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5ch;
    cursor: pointer;

    /* Hit area & shape */
    border-radius: var(--radius);

    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;  /* avoids 300ms delays on old mobile stacks */

    &:hover {
      box-shadow: none;
      background: oklch(from var(--hover-color, var(--surface)) calc(l + 0.05) c h / 50%);

    }
    &:focus-visible {
      outline: var(--brand);
    }
    & > .icon {
      pointer-events: none;
      margin: 0;
    }
  }

  .forum {
    --nav-h: calc(2.5cap + 2*var(--s-2));
    --forum-h: calc(var(--nav-h) + var(--s-2));
    position: fixed;
    top: var(--forum-h);
    right: var(--s-2);
    z-index: 20;
    max-width: 30ch;
    max-height: 80dvh;
    box-shadow: var(--shadow-high);
    pointer-events: none;

    overflow-y: scroll;
    scroll-behavior: auto;
    scrollbar-gutter: stable;
    scrollbar-width: thin;
    scrollbar-color: color-mix(in oklch, var(--ink) 10%, transparent) transparent;

    transform: translateY(-100%);
    opacity: 0;
    display: none;
    transition-timing-function: ease-in;
    transition:
      opacity .3s,
      display .3s allow-discrete,
      transform .3s;
  }

  .forum.active {
    opacity: 1;
    transform: translateY(0);
    display: block;
    pointer-events: auto;
    transition-timing-function: ease-out;
    @starting-style {
      opacity: 0;
      transform: translateY(-100%);
    }
  }

  .post-contents {
    --frame: 0.5rem;
    margin-inline: calc(var(--frame)* -1);
    border: var(--border);
    border-radius: var(--s-1);
    background: var(--surface-high);
    padding: calc(var(--frame) / var(--ratio)) var(--frame);
  }

  .mention {
    background: linear-gradient(
      to right,
      var(--success) 0 4px,
      transparent 4px)
      padding-box, var(--surface-high);
  }
  .mention-name {
    font-weight: 700;
    color: oklch( from var(--success) calc(l + 0.05) c h);
  }

  .forum-reaction-icon {
    inline-size: 1rem;
    block-size: 1rem;
  }

  button.forum-reaction-btn {
    padding: var(--s-4);
    border-radius: var(--s-1);
  }

  button.forum-reload-btn {
    position: absolute;
    top: calc(2.5cap + 3*var(--s-2));
    right: var(--s-2);
    z-index: 25;
    padding: var(--s-4);

    color: var(--muted);

    &:hover{
      color: var(--ink);
      background: transparent;
    }

    opacity: 0;
    display: none;
    transition-timing-function: ease-in;
    transition:
      opacity .2s,
      display .2s allow-discrete;

    &.active {
      opacity: 1;
      display: flex;
      pointer-events: auto;
      transition-delay: .3s;
      transition-timing-function: ease-out;

      @starting-style {
        opacity: 0;
      }
    }
  }

  button.forum-scroll-btn {
    position: absolute;
    top: calc(2.5cap + 2*var(--s-2) + 80dvh - var(--s1));
    right: calc(var(--s-1));
    z-index: 25;
    padding: var(--s-4);

    color: var(--muted);

    &:hover{
      color: var(--ink);
      background: transparent;
    }

    opacity: 0;
    display: none;
    transition-timing-function: ease-in;
    transition: opacity .2s;

    &.active {
      opacity: 1;
      display: flex;
      pointer-events: auto;
      transition-timing-function: ease-out;

      @starting-style {
        opacity: 0;
      }
    }
  }

  .forum-scroll-icon {
    inline-size: 1.5rem;
    block-size: 1.5rem;
  }

  button.forum-author-btn {
    color: var(--success);
    padding: 0 var(--s-2);
    background: transparent;
    border-radius: var(--s-2);

    &:hover {
      color: oklch(from var(--success) calc(l + 0.05) c h);
      background: oklch(from var(--success) calc(l + 0.05) c h / 25%);
      box-shadow: none;
    }
  }

  button.forum-btn-pressed {
    transform: translateY(calc(-1 * var(--s-6)));
    background: var(--brand);
    box-shadow: inset 0 calc(-1 * var(--s-6)) 0 color-mix(in oklch, black 40%, var(--brand));

    &:hover {
      transform: translateY(0);
      background: color-mix(in oklch, black 20%, var(--brand));
      color: var(--muted);
      box-shadow: none;
    }
  }

  .has-new::after {
    content: "";
    z-index: 25;
    position: absolute;
    inset-block-start: -2px;
    inset-inline-end: -2px;
    width: 8px; height: 8px;
    border-radius: 9999px;
    background: var(--success);
    outline: 2px solid var(--surface, #0b0b0b);
  }

  button, .button {
    font: inherit;
    color: white;
    font-weight: 700;
    text-decoration: none;
    background: var(--btn-color);
    border: none;
    border-radius: var(--radius);
    padding: var(--s-1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    z-index: 1;

    transition:
      background 0.3s,
      box-shadow 0.3s;
    &:hover {
      background: oklch(from var(--btn-color) calc(l + 0.05) c h);
      box-shadow: 0 0 var(--s1) oklch(from var(--btn-color) calc(l + 0.05) c h / 50%);
    }

    &.destructive {
      --btn-color: var(--error);
      &.tetriary {
        color: var(--muted);
      }
    }
    &.success {
      --btn-color: var(--success)
    }

    &.secondary {
      color: var(--btn-color);
      background: transparent;
      outline: var(--s-5) solid oklch(from var(--btn-color) l c h / 70%);

      transition: color 0.3s, outline-color 0.3s;
      &:hover {
        color: oklch(from var(--btn-color) calc(l + 0.05) c h);
        background: transparent;
        outline-color: oklch(from var(--btn-color) calc(l + 0.05) c h / 70%);
      }
    }

    &.tetriary {
      color: var(--btn-color);
      background: transparent;

      transition: color 0.3s;
      &:hover {
        background: transparent;
        box-shadow: none;
        color: oklch(from var(--btn-color) calc(l + 0.05) c h);
      }
    }
  }
  a.button {
    display: inline-block;
    text-decoration: none;
    text-align: center;
  }



  @keyframes spinner {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
  }

  .loading-spinner {
    flex: none;
    width: 2.5rem;
    height: 2.5rem;
    border: 0.3rem solid transparent;
    border-top: 0.3rem solid var(--brand);
    border-radius: 50%;
    animation: spinner 1s linear infinite;
    margin: 0 auto;
  }

  .test-layout {
    background: oklch(from var(--bg) calc(l - 0.1) c h);
    padding: var(--padding);
    padding: var(--s0);
    border-radius: var(--radius);
  }

  .toaster-test {
    min-inline-size: 10ch;
    border: 1px solid;
    border-radius: 4px;
    font-weight: 600;
    text-align: center;
    padding: var(--s-1);
  }

  #info-test {
    color: var(--leptoaster-info-text-color);
    background: var(--leptoaster-info-background-color);
    border-color: var(--leptoaster-info-border-color);
  }
  #success-test {
    color: var(--leptoaster-success-text-color);
    background: var(--leptoaster-success-background-color);
    border-color: var(--leptoaster-success-border-color);
  }
  #error-test {
    color: var(--leptoaster-error-text-color);
    background: var(--leptoaster-error-background-color);
    border-color: var(--leptoaster-error-border-color);
  }

}
